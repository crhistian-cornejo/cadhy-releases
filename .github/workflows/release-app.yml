name: Release App

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0-beta.1)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (build without releasing)'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================================================
  # Windows Build
  # ============================================================================
  build-windows:
    name: Build (Windows x64)
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout source code from private repo
        uses: actions/checkout@v4
        with:
          repository: crhistian-cornejo/CADHY
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          path: source

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.1

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: x86_64-pc-windows-msvc

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            source -> source/target
            source/apps/desktop/src-tauri -> source/apps/desktop/src-tauri/target

      - name: Setup OpenCASCADE
        shell: powershell
        working-directory: source
        run: .\scripts\occt\setup.ps1

      - name: Install Dependencies
        working-directory: source
        working-directory: source
        run: bun install --frozen-lockfile

      - name: Build App
        shell: powershell
        working-directory: source
        env:
          OCCT_ROOT: ${{ github.workspace }}\source\deps\occt-7.9.2
          DEP_OCCT_ROOT: ${{ github.workspace }}\source\deps\occt-7.9.2
          CASROOT: ${{ github.workspace }}\source\deps\occt-7.9.2
          # Tauri updater signing
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # Windows code signing (optional)
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
        working-directory: source
        run: .\scripts\dev\run-with-occt.ps1 "bun run --filter @cadhy/desktop tauri:build"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: |
            source/apps/desktop/src-tauri/target/release/bundle/nsis/*.exe
            source/apps/desktop/src-tauri/target/release/bundle/nsis/*.exe.sig
            source/apps/desktop/src-tauri/target/release/bundle/msi/*.msi
            source/apps/desktop/src-tauri/target/release/bundle/msi/*.msi.sig
          if-no-files-found: error

  # ============================================================================
  # macOS Build (Universal: Intel + Apple Silicon)
  # ============================================================================
  build-macos:
    name: Build (macOS ${{ matrix.arch }})
    runs-on: macos-latest
    permissions:
      contents: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            arch: arm64
          - target: x86_64-apple-darwin
            arch: x64

    steps:
      - name: Checkout source code from private repo
        uses: actions/checkout@v4
        with:
          repository: crhistian-cornejo/CADHY
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          path: source

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.1

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            source -> source/target
            source/apps/desktop/src-tauri -> source/apps/desktop/src-tauri/target

      - name: Install OpenCASCADE via Homebrew
        run: |
          brew install opencascade
          echo "OCCT installed at: $(brew --prefix opencascade)"

      - name: Install Dependencies
        working-directory: source
        run: bun install --frozen-lockfile

      # Apple Code Signing
      - name: Import Apple Certificate
        if: ${{ secrets.APPLE_CERTIFICATE != '' }}
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          echo $APPLE_CERTIFICATE | base64 --decode > certificate.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          rm certificate.p12

      - name: Build App
        env:
          # Tauri updater signing
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # Apple code signing
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        working-directory: source
        run: |
          bun run --filter @cadhy/desktop tauri:build:macos -- --target ${{ matrix.target }}

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries-${{ matrix.arch }}
          path: |
            source/apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
            source/apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg.sig
            source/apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app
            source/apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz
            source/apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz.sig
          if-no-files-found: warn

  # ============================================================================
  # Linux Build
  # ============================================================================
  build-linux:
    name: Build (Linux x64)
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout source code from private repo
        uses: actions/checkout@v4
        with:
          repository: crhistian-cornejo/CADHY
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          path: source

      - name: Install Linux dependencies
        working-directory: source
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libocct-foundation-dev \
            libocct-modeling-algorithms-dev \
            libocct-modeling-data-dev \
            libocct-data-exchange-dev \
            libocct-visualization-dev

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.1

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: x86_64-unknown-linux-gnu

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            source -> source/target
            source/apps/desktop/src-tauri -> source/apps/desktop/src-tauri/target

      - name: Install Dependencies
        working-directory: source
        run: bun install --frozen-lockfile

      - name: Build App
        env:
          # Tauri updater signing
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        working-directory: source
        run: bun run --filter @cadhy/desktop tauri:build

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-binaries
          path: |
            source/apps/desktop/src-tauri/target/release/bundle/deb/*.deb
            source/apps/desktop/src-tauri/target/release/bundle/rpm/*.rpm
            source/apps/desktop/src-tauri/target/release/bundle/appimage/*.AppImage
            source/apps/desktop/src-tauri/target/release/bundle/appimage/*.AppImage.sig
          if-no-files-found: warn

  # ============================================================================
  # Create GitHub Release with Update Manifest
  # ============================================================================
  release:
    name: Create Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') && github.event.inputs.dry_run != 'true'
    permissions:
      contents: write

    steps:
      - name: Checkout source code from private repo
        uses: actions/checkout@v4
        with:
          repository: crhistian-cornejo/CADHY
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          path: source

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -laR artifacts/

      - name: Create release notes
        run: |
          cat > release-notes.md << 'EOF'
          # CADHY v${{ steps.version.outputs.version }}

          > First Beta Release - Hydraulic CAD System

          ## Installation

          Download the installer for your platform below and run it.

          **Windows:** `.exe` installer
          **macOS:** `.dmg` disk image
          **Linux:** `.AppImage` executable

          ## What's Included

          - CAD operations: Boolean, Fillet, Chamfer, Shell
          - Export formats: STEP, STL, OBJ, GLB
          - Measurement tools
          - 3D viewport with OpenCASCADE backend

          See [CHANGELOG](https://github.com/crhistian-cornejo/CADHY/blob/main/CHANGELOG.md) for full details.
          EOF

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "release" ]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Generate update manifest (latest.json)
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RELEASES_REPO="crhistian-cornejo/cadhy-releases"

          # Create latest.json for Tauri updater
          cat > artifacts/latest.json << EOF
          {
            "version": "${VERSION}",
            "notes": "See the release notes at https://github.com/${RELEASES_REPO}/releases/tag/v${VERSION}",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "darwin-aarch64": {
                "signature": "$(cat artifacts/macos-binaries-arm64/*.app.tar.gz.sig 2>/dev/null || echo '')",
                "url": "https://github.com/${RELEASES_REPO}/releases/download/v${VERSION}/CADHY_${VERSION}_aarch64.app.tar.gz"
              },
              "darwin-x86_64": {
                "signature": "$(cat artifacts/macos-binaries-x64/*.app.tar.gz.sig 2>/dev/null || echo '')",
                "url": "https://github.com/${RELEASES_REPO}/releases/download/v${VERSION}/CADHY_${VERSION}_x64.app.tar.gz"
              },
              "linux-x86_64": {
                "signature": "$(cat artifacts/linux-binaries/*.AppImage.sig 2>/dev/null || echo '')",
                "url": "https://github.com/${RELEASES_REPO}/releases/download/v${VERSION}/CADHY_${VERSION}_amd64.AppImage"
              },
              "windows-x86_64": {
                "signature": "$(cat artifacts/windows-binaries/*.exe.sig 2>/dev/null || echo '')",
                "url": "https://github.com/${RELEASES_REPO}/releases/download/v${VERSION}/CADHY_${VERSION}_x64-setup.exe"
              }
            }
          }
          EOF

          echo "Generated latest.json:"
          cat artifacts/latest.json

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/windows-binaries/**/*
            artifacts/macos-binaries-arm64/**/*
            artifacts/macos-binaries-x64/**/*
            artifacts/linux-binaries/**/*
            artifacts/latest.json
          generate_release_notes: false
          body_path: ${{ github.workspace }}/release-notes.md
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          # IMPORTANT: Don't include source code
          include_source_code: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
